<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>單字練習 V4.8 (整體貼上 + JSON 匯入匯出)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; }
        #sidebar { width: 200px; background-color: #f0f0f0; padding: 20px; box-sizing: border-box; }
        #sidebar button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; }
        #content { flex: 1; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .section { margin-bottom: 20px; }
        .toggle-header { cursor: pointer; font-weight: bold; margin-top: 20px; }
        .word-card { border: 1px solid #ccc; border-radius: 10px; padding: 10px; margin: 10px 0; }
        textarea { width: 100%; resize: none; overflow: hidden; }
        .green { background-color: #d4edda; }
        .yellow { background-color: #fff3cd; }
        .red { background-color: #f8d7da; }
        .hidden { display: none; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-row input { flex: 1; }
    </style>
</head>
<body>
<div id="sidebar">
    <button onclick="showSection('addWordSection')">新增單字</button>
    <button onclick="showSection('wordListSection')">單字清單</button>
    <button onclick="showPracticeSection()">練習區</button>
    <button onclick="showSection('listeningSection')">聽力區</button>
    <button onclick="exportWordsJSON()">匯出 JSON 檔</button>
    <input type="file" id="jsonImport" accept=".json" style="display:none" onchange="importWordsJSON(event)" />
    <button onclick="document.getElementById('jsonImport').click()">匯入 JSON 檔</button>
</div>
    <div id="content">
        <div id="addWordSection" class="section">
            <h2>新增單字</h2>
            <div class="input-row"><input type="text" id="newWord" placeholder="英文單字" /></div>
            <div class="input-row"><input type="text" id="newMeaning" placeholder="中文意思" /></div>
            <div class="input-row"><input type="text" id="newExample" placeholder="英文例句" /></div>
            <div class="input-row"><input type="text" id="newExampleCn" placeholder="例句中文翻譯" /></div>
            <button onclick="addWord()">新增</button>
            <button onclick="window.open('https://chatgpt.com/share/68840728-6350-8006-bb18-2ae10ebc5430', '_blank')">AI範例</button>

            <h3>整體貼上</h3>
            <textarea id="bulkInput" rows="6" placeholder="貼上四行格式的內容"></textarea>
            <button onclick="importBulkWord()">匯入</button>

           
        </div>

        <div id="wordListSection" class="section hidden">
            <h2>單字清單</h2>
            <input type="text" id="searchInput" placeholder="搜尋英文或中文" oninput="renderWords()" />
            <div>
                <div class="toggle-header" onclick="toggleSection('greenList')">會了 ▶</div>
                <div id="greenList" class="hidden"></div>
                <div class="toggle-header" onclick="toggleSection('yellowList')">不熟 ▶</div>
                <div id="yellowList" class="hidden"></div>
                <div class="toggle-header" onclick="toggleSection('redList')">不會 ▶</div>
                <div id="redList" class="hidden"></div>
            </div>
        </div>

        <div id="practiceSection" class="section hidden">
            <h2>練習區</h2>
            <button onclick="refreshPractice()">重新整理</button>
            <div id="practiceArea"></div>
        </div>

        <!-- 新增：聽力區 -->
        <div id="listeningSection" class="section hidden">
            <h2>聽力區</h2>
            <div style="display:flex; gap:20px; align-items:flex-start;">
                <div style="width:240px;">
                    <div style="margin-bottom:10px;">
                        <button onclick="loadListeningWords()">隨機選 5 個有錄音的單字</button>
                    </div>
                    <div style="margin-bottom:10px;">
                        <button id="playAllBtn" onclick="playAllSelected()" disabled>播放全部</button>
                    </div>
                    <div style="color:#666; font-size:13px;">備註：需先上傳錄音才會被選入</div>
                </div>
                <div id="listeningRight" style="flex:1;"></div>
            </div>
        </div>
    </div>

    <input type="file" id="audioUpload" accept="audio/*" style="display:none" onchange="handleAudioUpload()" />

    <script>
        let words = JSON.parse(localStorage.getItem('words')) || [];
        let recordingsDB;
        let currentUploadIndex = null;

        function initDB() {
            let request = indexedDB.open('WordPracticeDB', 1);
            request.onupgradeneeded = e => {
                let db = e.target.result;
                if (!db.objectStoreNames.contains('recordings')) {
                    db.createObjectStore('recordings', { keyPath: 'word' });
                }
            };
            request.onsuccess = e => {
                recordingsDB = e.target.result;
                renderWords();
                refreshPractice();
            };
        }

        function saveWords() {
            localStorage.setItem('words', JSON.stringify(words));
        }

        function showSection(sectionId) {
            document.querySelectorAll('#content > .section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            if (sectionId === 'wordListSection') renderWords();
        }

        function showPracticeSection() {
            showSection('practiceSection');
            refreshPractice();
        }

        function toggleSection(id) {
            const section = document.getElementById(id);
            section.classList.toggle('hidden');
            const header = section.previousElementSibling;
            if (section.classList.contains('hidden')) {
                header.innerHTML = header.innerHTML.replace('▼', '▶');
            } else {
                header.innerHTML = header.innerHTML.replace('▶', '▼');
                adjustTextareas(section);
            }
        }

        
        function adjustTextareas(parent = document) {
            parent.querySelectorAll('textarea').forEach(t => {
             // 空白的不處理，保留 rows 預設高度
             if (!t.value || t.value.trim() === '') {
               t.style.height = ''; // 清掉 JS 設定，交給 rows
               return;
              }
              t.style.height = 'auto';
              t.style.height = t.scrollHeight + 'px';
            });
        }

        function renderWords() {
            ['greenList', 'yellowList', 'redList'].forEach(id => (document.getElementById(id).innerHTML = ''));
            const search = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
            let filteredWords = words;
            if (search) {
                filteredWords = words.filter(item =>
                    item.word.toLowerCase().includes(search) ||
                    item.meaning.toLowerCase().includes(search)
                );
            }
            const sortedWords = filteredWords.slice().sort((a, b) => b.timestamp - a.timestamp);

            sortedWords.forEach((item, index) => {
                checkRecording(item.word, hasRecording => {
                    const card = createWordCard(item, words.indexOf(item), hasRecording);
                    document.getElementById(item.level + 'List').appendChild(card);
                    adjustTextareas();
                });
            });
        }

        function createWordCard(item, index, hasRecording, isPractice = false) {
            const card = document.createElement('div');
            card.className = `word-card ${item.level}`;
            // 顯示：英文單字 / 翻譯 / 例句 / 例句翻譯 / 例句 / 例句（例句重複兩次）
            const textContent = `${item.word}\n${item.meaning}\n\n例句：\n${item.example}\n${item.exampleCn}\n${item.example}\n${item.example}`;

            // 重要：如果有合法 index，優先從最新的 words[index].reviewCount 取得數值（避免顯示過時的資料）
            const displayCount = (Number.isInteger(index) && index >= 0 && words[index]) ? (words[index].reviewCount || 0) : (item.reviewCount || 0);
            card.innerHTML = `
        <div class="review-count">複習次數：${displayCount}</div>
        <textarea readonly>${textContent}</textarea><br>
        <button onclick="speakContent(\`${textContent}\`)">語音</button>
        <button onclick="getTextForTTS(\`${textContent}\`)">取得語音</button>
        <button onclick="changeLevel(${index}, 'green')">會了</button>
        <button onclick="changeLevel(${index}, 'yellow')">不熟</button>
        <button onclick="changeLevel(${index}, 'red')">不會</button>
        <button onclick="showEditForm(${index})">編輯</button>
        <button onclick="deleteWord(${index})">刪除</button>
        <button onclick="uploadRecording(${index})">上傳錄音</button>
        ${hasRecording ? `<button onclick="playRecording('${item.word}')">播放錄音</button>` : ''}
        <div id="editForm${index}" class="hidden"></div>
        ${isPractice ? `<button onclick="addReviewCount(${index}, this)">複習了</button>` : ''}
    `;
             return card;
        }

        function importBulkWord() {
            const input = document.getElementById('bulkInput').value.trim();
            const lines = input.split('\n').map(line => line.trim());
            if (lines.length === 4 && lines.every(line => line !== '')) {
                words.push({
                    word: lines[0],
                    meaning: lines[1],
                    example: lines[2],
                    exampleCn: lines[3],
                    level: 'red',
                    timestamp: Date.now(),
                });
                saveWords();
                renderWords();
                document.getElementById('bulkInput').value = '';
                alert('輸入成功');
            } else {
                alert('格式有誤，匯入失敗');
            }
        }

        // JSON 匯出
        function exportWordsJSON() {
            if (words.length === 0) {
                alert('沒有單字可以匯出');
                return;
            }
            const content = JSON.stringify(words, null, 2);
            const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'words_export.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // JSON 匯入
        function importWordsJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const importedWords = JSON.parse(e.target.result);
                    if (Array.isArray(importedWords)) {
                        words = importedWords;
                        saveWords();
                        renderWords();
                        refreshPractice();
                        alert('匯入成功');
                    } else {
                        alert('JSON格式錯誤，匯入失敗');
                    }
                } catch {
                    alert('讀取檔案失敗，請確認格式正確');
                }
                event.target.value = ''; // 清空，方便下次匯入
            };
            reader.readAsText(file);
        }

        function checkRecording(word, callback) {
            const transaction = recordingsDB.transaction(['recordings'], 'readonly');
            const store = transaction.objectStore('recordings');
            const request = store.get(word);
            request.onsuccess = () => callback(!!request.result);
        }

        // 新增：回傳 Promise 的非同步檢查 (方便一次拿到多個結果)
        function checkRecordingAsync(word) {
            return new Promise((resolve) => {
                const transaction = recordingsDB.transaction(['recordings'], 'readonly');
                const store = transaction.objectStore('recordings');
                const request = store.get(word);
                request.onsuccess = () => resolve(!!request.result);
                request.onerror = () => resolve(false);
            });
        }

        // 取得最多 count 個隨機有錄音的單字（非同步）
        async function getRandomRecordedWords(count = 5) {
            const candidates = [];
            // 同步檢查所有 words 是否有錄音
            for (let w of words) {
                if (!w.word) continue;
                const has = await checkRecordingAsync(w.word);
                if (has) candidates.push(w);
            }
            if (candidates.length === 0) return [];
            // 隨機打散並取前 count
            for (let i = candidates.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
            }
            return candidates.slice(0, count);
        }

        // 載入並顯示右欄的單字卡（最多 5 個）
        async function loadListeningWords() {
            const right = document.getElementById('listeningRight');
            right.innerHTML = '載入中...';
            const list = await getRandomRecordedWords(5);
            right.innerHTML = '';
            if (!list || list.length === 0) {
                right.innerHTML = '<div>找不到有錄音的單字，請先在單字清單上傳錄音。</div>';
                document.getElementById('playAllBtn').disabled = true;
                return;
            }
            // 儲存目前播放列表到 DOM dataset
            right.dataset.playlist = JSON.stringify(list.map(w => w.word));
            document.getElementById('playAllBtn').disabled = false;

            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'word-card ' + item.level;
                div.style.display = 'flex';
                div.style.gap = '10px';
                div.style.alignItems = 'center';
                div.innerHTML = `
                    <div style="flex:1">
                        <div><strong>${item.word}</strong> <span style="color:#666">(${item.meaning || ''})</span></div>
                        <div style="font-size:13px; color:#444">複習次數：${item.reviewCount || 0}</div>
                    </div>
                    <div style="display:flex; gap:6px; align-items:center">
                        <button onclick="playSingleSequential('${item.word}', this)">▶ 播放</button>
                    </div>
                `;
                right.appendChild(div);
            });
        }

        // 以 Promise 回傳播放結束事件
        function playRecordingPromise(word) {
            return new Promise((resolve, reject) => {
                const transaction = recordingsDB.transaction(['recordings'], 'readonly');
                const store = transaction.objectStore('recordings');
                const request = store.get(word);
                request.onsuccess = function () {
                    if (request.result) {
                        const audio = new Audio(request.result.data);
                        audio.onended = () => resolve();
                        audio.onerror = () => resolve(); // 不讓錯誤阻斷整個序列
                        audio.play().catch(() => resolve());
                    } else {
                        resolve();
                    }
                };
                request.onerror = () => resolve();
            });
        }

        // 個別按鍵播放（同時把按鍵 disable 以防重複按）
        async function playSingleSequential(word, btn) {
            if (!recordingsDB) return;
            if (btn) {
                btn.disabled = true;
                const orig = btn.innerText;
                btn.innerText = '播放中...';
                await playRecordingPromise(word);
                btn.innerText = orig;
                btn.disabled = false;
            } else {
                await playRecordingPromise(word);
            }
        }

        // 依序播放右欄的播放清單
        async function playAllSelected() {
            const right = document.getElementById('listeningRight');
            const playAllBtn = document.getElementById('playAllBtn');
            if (!right.dataset.playlist) return;
            const list = JSON.parse(right.dataset.playlist);
            playAllBtn.disabled = true;
            const origText = playAllBtn.innerText;
            playAllBtn.innerText = '播放中...';
            for (let w of list) {
                await playRecordingPromise(w);
            }
            playAllBtn.innerText = origText;
            playAllBtn.disabled = false;
        }

        function downloadRecording(word) {
            const transaction = recordingsDB.transaction(['recordings'], 'readonly');
            const store = transaction.objectStore('recordings');
            const request = store.get(word);
            request.onsuccess = function () {
                if (request.result) {
                    const a = document.createElement('a');
                    a.href = request.result.data;
                    a.download = `${word}.mp3`;
                    a.click();
                }
            };
        }

        function deleteRecording(word) {
            const transaction = recordingsDB.transaction(['recordings'], 'readwrite');
            const store = transaction.objectStore('recordings');
            store.delete(word);
            transaction.oncomplete = () => {
                renderWords();
                refreshPractice();
            };
        }

        function showEditForm(index) {
            document.getElementById(`editForm${index}`).classList.remove('hidden');
        }

        function cancelEdit(index) {
            document.getElementById(`editForm${index}`).classList.add('hidden');
        }

        function saveEdit(index, btn) {
            const newWord = document.getElementById(`editWord${index}`).value.trim();
            const newMeaning = document.getElementById(`editMeaning${index}`).value.trim();
            const newExample = document.getElementById(`editExample${index}`).value.trim();
            const newExampleCn = document.getElementById(`editExampleCn${index}`).value.trim();
            if (newWord && newMeaning && newExample && newExampleCn) {
                words[index] = { ...words[index], word: newWord, meaning: newMeaning, example: newExample, exampleCn: newExampleCn };
                saveWords();
                renderWords();
                refreshPractice();
            }
        }

        function addWord() {
            const word = document.getElementById('newWord').value.trim();
            const meaning = document.getElementById('newMeaning').value.trim();
            const example = document.getElementById('newExample').value.trim();
            const exampleCn = document.getElementById('newExampleCn').value.trim();
            if (word && meaning && example && exampleCn) {
                words.push({ word, meaning, example, exampleCn, level: 'red', timestamp: Date.now(), reviewCount: 0 });
                saveWords();
                renderWords();
                document.getElementById('newWord').value = '';
                document.getElementById('newMeaning').value = '';
                document.getElementById('newExample').value = '';
                document.getElementById('newExampleCn').value = '';
            }
        }

        function deleteWord(index) {
            words.splice(index, 1);
            saveWords();
            renderWords();
        }

        function addReviewCount(index, btn) {
            // 嘗試用傳入的 index，如果不合法就從卡片內容找對應的單字再比對
            let idx = Number.isInteger(index) ? index : parseInt(index, 10);
            if (isNaN(idx) || idx < 0 || idx >= words.length) {
                const card = btn && btn.closest && btn.closest('.word-card');
                const textarea = card ? card.querySelector('textarea') : null;
                const wordText = textarea ? textarea.value.split('\n')[0].trim() : null;
                if (wordText) {
                    idx = words.findIndex(w => w.word === wordText);
                }
            }
            if (idx === -1 || idx === undefined) return;

            words[idx].reviewCount = (words[idx].reviewCount || 0) + 1;
            saveWords();

            // 更新該卡片上的顯示（避免整頁重新 render）
            if (btn) {
                const card = btn.closest('.word-card');
                if (card) {
                    const countEl = card.querySelector('.review-count');
                    if (countEl) countEl.textContent = `複習次數：${words[idx].reviewCount}`;
                    btn.disabled = true;
                    btn.innerText = '已複習';
                }
            }
        }

        function changeLevel(index, level) {
            words[index].level = level;
            saveWords();
            renderWords();
        }

        function getRandomWords() {
            function getSortedByReview(arr, count) {
                // 依複習次數由小到大排序，取前 count 個
                return arr
                    .slice()
                    .sort((a, b) => (a.reviewCount || 0) - (b.reviewCount || 0))
                    .slice(0, count);
            }

            const greenWords = words.filter(w => w.level === 'green');
            const yellowWords = words.filter(w => w.level === 'yellow');
            const redWords = words.filter(w => w.level === 'red');

            return [
                ...getSortedByReview(greenWords, 5),
                ...getSortedByReview(yellowWords, 3),
                ...getSortedByReview(redWords, 2)
            ];
        }

        function refreshPractice() {
            const practiceArea = document.getElementById('practiceArea');
            practiceArea.innerHTML = '';
            const practiceWords = getRandomWords();
            practiceWords.forEach(item => {
                const globalIndex = words.findIndex(w => w === item || (w.word===item.word && w.meaning===item.meaning));
                checkRecording(item.word, hasRecording => {
                    const card = createWordCard(item, globalIndex, hasRecording, true); // isPractice = true
                    practiceArea.appendChild(card);
                    adjustTextareas(practiceArea);
                });
            });
            // 不自動增加 reviewCount，按鈕按下時才會增加
        }

        function speakContent(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }

        function getTextForTTS(text) {
            navigator.clipboard.writeText(text).then(() => {
                window.open('https://ttsmaker.com/zh-hk', '_blank');
            }).catch(() => {
                alert('無法複製文字，請手動複製');
            });
        }

 // 上傳錄音：設定要上傳的單字索引並開啟檔案選擇器
function uploadRecording(index) {
    currentUploadIndex = index;
    document.getElementById('audioUpload').value = '';
    document.getElementById('audioUpload').click();
}

// 處理上傳檔案並儲存到 IndexedDB（以 dataURL 儲存）
function handleAudioUpload(evt) {
    evt = evt || window.event;
    const file = (evt.target && evt.target.files && evt.target.files[0]) || document.getElementById('audioUpload').files[0];
    if (!file) return;
    if (currentUploadIndex === null || currentUploadIndex === undefined || !words[currentUploadIndex]) {
        alert('找不到對應的單字索引，請重新選擇上傳目標。');
        return;
    }
    const reader = new FileReader();
    reader.onload = function (e) {
        const dataUrl = e.target.result;
        const wordKey = words[currentUploadIndex].word;
        const transaction = recordingsDB.transaction(['recordings'], 'readwrite');
        const store = transaction.objectStore('recordings');
        store.put({ word: wordKey, data: dataUrl });
        transaction.oncomplete = function () {
            // 更新 UI
            renderWords();
            refreshPractice();
            // 若正在聽力區，重新載入
            try { loadListeningWords(); } catch (_) {}
            alert('上傳完成');
            currentUploadIndex = null;
            document.getElementById('audioUpload').value = '';
        };
        transaction.onerror = function () {
            alert('儲存錄音失敗');
            currentUploadIndex = null;
        };
    };
    reader.onerror = function () {
        alert('讀取檔案失敗');
    };
    reader.readAsDataURL(file);
}

// 播放單一錄音（wrapper，方便在不同地方呼叫）
async function playRecording(word) {
    if (!recordingsDB) return;
    await playRecordingPromise(word);
}

 window.onload = function() {
    initDB();
    adjustTextareas();
}
    </script>
</body>
</html>
